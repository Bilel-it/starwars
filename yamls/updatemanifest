node{
    def app
    stage('Clone repository'){
        checkout scm
    }
    stage ('Update GIT'){
        script{
            catchError(buildResult: 'SUCCESS', stageResult: 'FAILED'){
                withCredentials([usernamePassword(credentialsId: 'github', passwordVariable: 'GIT_PASSWORD', usernameVariable: 'GIT_USERNAME')]){
                    sh "git config user.email bilel.marzouk@esprit.tn"
                    sh "git config user.name Bilel-it"
                    sh "cat kubemanifets.yaml"
                    sh "sed -i 's+imagedockerpaas.azurecr.io/backend.*+imagedockerpaas.azurecr.io/backend:${DOCKERTAG}+g' kubemanifets.yaml"
                    sh "sed -i 's+imagedockerpaas.azurecr.io/frontend.*+imagedockerpaas.azurecr.io/frontend:${DOCKERTAG}+g' kubemanifets.yaml"
                    sh "cat kubemanifets.yaml"
                    sh "git add ."
                    sh "git commit -m 'Done by jenkins job changemanifest: ${DOCKERTAG}'"
                    sh "git push https://${GIT_USENAME}:${GIT_PASSWORD}@github.com/${GIT_USERNAME}/yamls/kubemanifets.yaml.git HEAD:main"
                }
            }
        }
    }
}
